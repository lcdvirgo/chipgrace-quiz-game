<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chip & Grace's Quiz Game</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<style>
    .player-result {
        transition: all 0.3s ease-in-out;
    }
    
    .player-result:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .screen {
        display: none;
    }

    .screen.active {
        display: block;
    }
</style>  
<body class="bg-gray-100 min-h-screen">
    <!-- Add audio element -->
    <audio id="lobby-music" loop preload="auto">
        <source src="audio/lobby-music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <audio id="countdown-music" preload="auto">
        <source src="audio/countdown-30.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <div class="fixed bottom-4 right-4 flex items-center gap-4">
        <button id="music-toggle" 
                class="p-2 bg-white rounded-lg shadow-md hover:bg-gray-50 transition-colors"
                onclick="toggleMusic()">
            <i id="music-icon" data-lucide="volume-x" class="w-6 h-6 text-gray-600"></i>
        </button>
        <div id="connection-status" class="px-3 py-2 rounded-lg bg-white shadow-md"></div>
    </div>
    <!-- Registration Screen -->
    <div id="registration-screen" class="screen active p-4 md:p-8">
        <div class="max-w-2xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-8 text-gray-800">
                Welcome to Chip & Grace's Quiz!
            </h1>
            
            <form id="join-game-form" class="space-y-6">
                <div class="space-y-4">
                    <label for="player-name" class="block text-lg font-medium text-gray-700">
                        Enter your name
                    </label>
                    <input 
                        type="text" 
                        id="player-name" 
                        required 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Your name"
                    >
                </div>
                <button 
                    type="submit"
                    class="w-full py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-200"
                >
                    Join Game
                </button>
            </form>

            <!-- Waiting Room -->
            <div id="waiting-room" class="hidden mt-8">
                <h2 class="text-2xl font-semibold text-center mb-4">Players in Room</h2>
                <div id="player-list" class="flex flex-wrap justify-center gap-3">
                    <!-- Players will be added here dynamically -->
                </div>
                <p class="text-center mt-4 text-gray-600">
                    Waiting for host to start the game...
                </p>
                <div id="host-controls" class="invisible mt-8 border-t border-gray-200 pt-6">
                    <button 
                        id="start-game-btn"
                        class="w-full py-3 px-6 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200"
                    >
                        Start Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Screen -->
    <div id="question-screen" class="screen hidden p-4">
        <div class="max-w-3xl mx-auto">
            <h2 id="question-text" class="text-xl md:text-2xl font-semibold text-center mb-6"></h2>
            
            <div class="text-2xl font-bold text-center mb-4 timer-text"></div>
            <div class="h-4 bg-gray-200 rounded-full overflow-hidden mb-8">
                <div class="timer-progress h-full bg-gradient-to-r from-blue-500 to-red-500 transition-all duration-1000"></div>
            </div>
    
            <div class="grid grid-cols-1 gap-4">
                <button id="answer-0" class="answer-btn bg-red-500 text-white p-6 rounded-lg text-lg hover:scale-105 transition-transform"></button>
                <button id="answer-1" class="answer-btn bg-blue-500 text-white p-6 rounded-lg text-lg hover:scale-105 transition-transform"></button>
                <button id="answer-2" class="answer-btn bg-yellow-500 text-white p-6 rounded-lg text-lg hover:scale-105 transition-transform"></button>
                <button id="answer-3" class="answer-btn bg-green-500 text-white p-6 rounded-lg text-lg hover:scale-105 transition-transform"></button>
            </div>
        </div>
    </div>

    <!-- Answer Reveal Screen -->
    <div id="answer-reveal" class="screen hidden">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-6">Answer Results</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <button id="reveal-0" class="answer-btn p-6 rounded-lg text-lg"></button>
                <button id="reveal-1" class="answer-btn p-6 rounded-lg text-lg"></button>
                <button id="reveal-2" class="answer-btn p-6 rounded-lg text-lg"></button>
                <button id="reveal-3" class="answer-btn p-6 rounded-lg text-lg"></button>
            </div>

            <div id="player-results" class="space-y-3"></div>
            
            <button id="leaderboard-btn" onclick="showLeaderboard()"
                class="mt-8 w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                Show Leaderboard
            </button>
        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboard-screen" class="screen hidden">
        <div class="max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-center mb-6">Leaderboard</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-xl font-semibold text-left text-gray-600">Rank</th>
                            <th class="px-6 py-4 text-xl font-semibold text-left text-gray-600">Player</th>
                            <th class="px-6 py-4 text-xl font-semibold text-left text-gray-600">Score</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
    
            <button id="next-btn" 
                    class="mt-8 w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                Next Question
            </button>
        </div>
    </div>

    <!-- Final Results Screen -->
    <div id="final-screen" class="screen hidden">
        <div class="max-w-2xl mx-auto text-center">
            <h1 class="text-3xl font-bold mb-4">Game Over!</h1>
            <h2 class="text-2xl font-semibold mb-6">Top 5 Winners</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-gray-600">Rank</th>
                            <th class="px-6 py-3 text-left text-gray-600">Player</th>
                            <th class="px-6 py-3 text-left text-gray-600">Final Score</th>
                        </tr>
                    </thead>
                    <tbody id="final-leaderboard" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>

            <button onclick="resetGame()"
                class="mt-8 px-8 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                Play Again
            </button>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="fixed bottom-4 right-4 px-3 py-2 rounded-lg bg-white shadow-md">
        <!-- Connection status will be updated dynamically -->
    </div>

    <script>
        const socket = io('https://chipgrace-quiz-game.onrender.com', {
            transports: ['websocket', 'polling'],
            autoConnect: true,
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });

        let playerId = null;
        let isHost = false;
        let currentQuestionTimer = null;

        // Join game handler
        document.getElementById('join-game-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('player-name').value;
            const isHostInput = name.toLowerCase() === 'chipgrace';
            
            socket.emit('joinGame', {
                name: name,
                isHost: isHostInput
            });
        });

        // Socket event listeners
        socket.on('connect', () => {
            console.log('Connected to server');
            document.getElementById('connection-status').innerHTML = `
                <div class="text-green-600">Connected</div>
                <div class="text-xs text-gray-500">${socket.id}</div>
            `;
        });

        socket.on('connect_error', (error) => {
            console.error('Connection Error:', error);
            document.getElementById('connection-status').textContent = 'Connection Error: ' + error.message;
        });

        socket.on('gameJoined', (data) => {
            playerId = data.playerId;
            isHost = data.isHost;
            
            document.getElementById('registration-screen').classList.add('hidden');
            document.getElementById('waiting-room').classList.remove('hidden');
            
            if (isHost) {
                document.getElementById('host-controls').classList.remove('invisible');
            }
        });

        socket.on('updatePlayers', (players) => {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = players.map(player => `
                <div class="player-card bg-white rounded-lg p-3 shadow">
                    <span class="player-name">${player.name}</span>
                    ${player.isHost ? '<span class="host-badge ml-2 px-2 py-1 bg-green-100 text-green-800 rounded">Host</span>' : ''}
                </div>
            `).join('');
        });

        socket.on('showQuestion', (data) => {
            console.log('Received question data:', data);
            const { questionData } = data;
            
            console.log('Processing question:', questionData.question);
            console.log('Options:', questionData.options);

            // First hide waiting room
            document.getElementById('waiting-room').classList.add('hidden');
            document.getElementById('registration-screen').classList.add('hidden');
            
            // Then show question screen
            const questionScreen = document.getElementById('question-screen');
            questionScreen.classList.remove('hidden');

            // Update question text
            document.getElementById('question-text').textContent = questionData.question;

            // Update answer buttons
            const answerButtons = document.querySelectorAll('.answer-btn');
            answerButtons.forEach(button => {
                button.style.display = 'none'; // Hide all buttons first
                button.disabled = true; // Disable all buttons
            });

            // Show and update only the buttons we need
            questionData.options.forEach((option, index) => {
                const button = document.getElementById(`answer-${index}`);
                if (button) {
                    button.style.display = 'block';
                    button.textContent = option;
                    button.disabled = false;
                    button.onclick = () => submitAnswer(index); // Directly set onclick handler
                }
            });

            // Start timer
            startQuestionTimer(data.totalTime);
        });

        socket.on('showResults', (data) => {
            if (currentQuestionTimer) {
                clearInterval(currentQuestionTimer);
            }

            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById('answer-reveal').classList.remove('hidden');

            const resultsContainer = document.getElementById('player-results');
            resultsContainer.innerHTML = '';

            // Show correct answer
            resultsContainer.innerHTML = `
                <div class="text-xl font-bold text-center mb-6 text-green-600">
                    Correct Answer: ${data.correctAnswer}
                </div>
            `;

            // Show player results
            data.players.forEach(player => {
                const isCorrect = player.currentAnswer === data.correctAnswer;
                resultsContainer.innerHTML += `
                    <div class="player-result p-4 rounded-lg mb-2 ${isCorrect ? 'bg-green-100' : 'bg-red-100'}">
                        <div class="font-semibold">${player.name}</div>
                        <div class="text-sm">
                            Answer: ${player.currentAnswer || 'No answer'}
                            <span class="float-right">Score: ${player.score}</span>
                        </div>
                    </div>
                `;
            });
        });

        socket.on('showLeaderboard', (data) => {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById('leaderboard-screen').classList.remove('hidden');

            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = data.players
                .sort((a, b) => b.score - a.score)
                .map((player, index) => `
                    <tr class="bg-white">
                        <td class="px-6 py-4">${index + 1}</td>
                        <td class="px-6 py-4">${player.name}</td>
                        <td class="px-6 py-4">${player.score}</td>
                    </tr>
                `).join('');

            const nextButton = document.getElementById('next-btn');
            if (nextButton) {
                nextButton.style.display = data.isLastQuestion ? 'none' : 'block';
                if (isHost) {
                    nextButton.addEventListener('click', () => socket.emit('nextQuestion'), { once: true });
                } else {
                    nextButton.style.display = 'none';
                }
            }
        });

        socket.on('gameOver', (data) => {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById('final-screen').classList.remove('hidden');

            const finalLeaderboard = document.getElementById('final-leaderboard');
            finalLeaderboard.innerHTML = data.winners
                .map((player, index) => `
                    <tr class="bg-white">
                        <td class="px-6 py-4">${index + 1}</td>
                        <td class="px-6 py-4">${player.name}</td>
                        <td class="px-6 py-4">${player.score}</td>
                    </tr>
                `).join('');
        });

        // Helper functions
        function startQuestionTimer(duration) {
            const timerElement = document.querySelector('.timer-text');
            const progressElement = document.querySelector('.timer-progress');
            let timeLeft = duration;

            if (currentQuestionTimer) {
                clearInterval(currentQuestionTimer);
            }

            timerElement.textContent = `${Math.ceil(timeLeft / 1000)} seconds`;
            progressElement.style.width = '100%';

            currentQuestionTimer = setInterval(() => {
                timeLeft -= 1000;
                const seconds = Math.ceil(timeLeft / 1000);
                
                timerElement.textContent = `${seconds} seconds`;
                progressElement.style.width = `${(timeLeft / duration) * 100}%`;
                
                if (timeLeft <= 0) {
                    clearInterval(currentQuestionTimer);
                    submitAnswer(-1); // Auto-submit on timeout
                }
            }, 1000);
        }

        function submitAnswer(index) {
            if (currentQuestionTimer) {
                clearInterval(currentQuestionTimer);
            }

            const answerButtons = document.querySelectorAll('.answer-btn');
            answerButtons.forEach(btn => btn.disabled = true);

            const timerText = document.querySelector('.timer-text').textContent;
            const seconds = parseInt(timerText.split(' ')[0]) || 0;
            const timeLeft = seconds * 1000;
            
            const selectedButton = document.getElementById(`answer-${index}`);
            const answer = selectedButton ? selectedButton.textContent : null;
            
            console.log('Submitting answer:', {
                answer: answer,
                timeLeft: timeLeft
            });
            
            socket.emit('submitAnswer', {
                answer: answer,
                timeLeft: timeLeft
            });
        }

        // Start game button handler
        document.getElementById('start-game-btn').addEventListener('click', () => {
            if (isHost) {
                console.log('Host starting game...');
                // Hide waiting room immediately
                document.getElementById('waiting-room').classList.add('hidden');
                socket.emit('startGame');
            }
        });

        // Initialize any required UI elements
        function init() {
            // Hide all screens except registration
            document.querySelectorAll('.screen:not(#registration-screen)').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById('registration-screen').classList.remove('hidden');
        }

        // Call initialization
        init();
    </script>
</body>
</html>